
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="js/skycube/CSS/SC_Default.css">
</head>
<body>


<div id="render">
<!--h3>ALPHA</h3>-->
<div id="container"></div>
<div id="input"></div>
</div>

<script src="../build/three.js"></script>
<script src="js/skycube/SC_Common.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/skycube/SC_CubeViewport.js"></script>
<script src="js/skycube/SC_Raster.js"></script>
<script src="js/skycube/SC_OutputImg.js"></script>
<script src="js/skycube/SC_OutHUD.js"></script>
<script src="js/skycube/SC_Controller.js"></script>


<script src="js/skycube/FL/SCFL_CubeViewportHUD.js"></script>
<script src="js/skycube/FL/SCFL_HUDClose.js"></script>
<script src="js/skycube/FL/SCFL_InputFiles.js"></script>
<script src="js/skycube/FL/SCFL_GrabAndDropFiles.js"></script>
<script src="js/skycube/FL/SCFL_LoadFiles.js"></script>
<script src="js/skycube/FL/SCFL_LoadPanorama.js"></script>


<script src="../examples/js/libs/dat.gui.min.js"></script>

<script>


	function checkCompatible(){
		// Check for the various File API support.
		if (window.File && window.FileReader && window.FileList && window.Blob) {
		  // Great success! All the File APIs are supported.
		  return true;
		} 
		else {
		  alert('The File APIs are not fully supported in this browser.');
		  return false;
		}

		return false;
	}

	/*var controls = new THREE.OrbitControls( camera, renderer.domElement );
	controls.enableDamping = true;
	controls.dampingFactor = 0.3;
	controls.enableZoom = true;
	controls.enablePan = false;*/

	///////////////////////////////////////////////////////////////////////////////
	var type = ".jpg,.png,.tga,.tif";
	var loader = new SCFL_LoadFiles();
	var container;

	var width = window.innerWidth;
  	var height = window.innerHeight;

	var inputPage = new SCFL_InputFiles("input", type)

	var dropZone = new SCFL_GrabAndDropFiles("", type);

	var panaorama;

	var CM;
	var cubeView;
	var renderLoop;

	var loadStatus = false;

	var renderer;
	var outHUD;
	var cubeMenu;





	inputPage.activate();
	dropZone.activate();

	inputPage.onLoaded = function(){
		loadStatus = loader.load(inputPage.files);
		if(loadStatus){
			//

		}
		//test();
	}

	dropZone.onLoaded = function(){
		loadStatus = loader.load(dropZone.files);
		if(loadStatus){
			//
		}
		//test();
	}

	loader.onLoaded = function(){

		test();
	}

	///////////////////////////TEST////////////////////////////

	function test(){
		//console.log(loader.rImgWidth[0]);
		console.log(loader.rSelData.width);
		init();
		panaorama = new SCFL_LoadPanorama(loader.rSelData, renderer);
		inputPage.hidden();
		panaorama.onRTTUpdated = function(cubeRTTs,cubeMap) {
			// body...
			inputPage.deactivate();
			dropZone.deactivate();
			cubeView = new THREE.SC_CubeViewport(cubeRTTs, window.innerWidth, window.innerHeight, 75, renderer);
			cubeView.activate();

			animate();
			
			

			cubeMenu = new SCFL_CubeViewportHUD();
			cubeMenu.onExport = function(){
				CM=panaorama.updateCube(cubeView.deltaSkyBoxMatrix);
				//CM = cubeMap;
				outHUD = new THREE.SC_OutHUD(CM, window.innerWidth, window.innerHeight, renderer.domElement);
				var outHUDClose = new SCFL_HUDClose();
				outHUDClose.onClick = function(){
					outHUD.deactivate();
					cubeView.enableControls();
					cubeView.asNormal();
					cubeMenu.shown();
				};
				//controls.gui.close();
				cubeMenu.hide();
				outHUDClose.activate();


				cubeView.disableControls();
				cubeView.asBackground();

			};

			cubeMenu.onBackToInput = function(){
				cubeMenu.dispose();
				cubeView.dispose();

				cubeMenu = undefined;
				cubeView = undefined;
				panaorama = undefined;
				stop();

				inputPage.activate();
				dropZone.activate();
			};

			cubeMenu.onChangeCubeLayout = function(){
				cubeMenu.dispose();
				cubeView.dispose();

				cubeMenu = undefined;
				cubeView = undefined;
				//stop();

				panaorama.activateModal();
			};

			cubeMenu.onRotateU = function(){
				//cubeView.setCubeQuaternion(new THREE.Vector3( 0, 1, 0 ),cubeMenu.getRotationU());
				cubeView.setCubeRotation(new THREE.Vector3( 0, 1, 0 ),cubeMenu.getRotationU());
			};
			cubeMenu.onRotateV = function(){
				//cubeView.setCubeQuaternion(new THREE.Vector3( 1, 0, 0 ),cubeMenu.getRotationV());
				cubeView.setCubeRotation(new THREE.Vector3( 1, 0, 0 ),cubeMenu.getRotationV());
			};

			cubeMenu.activate();

		}

		panaorama.activate();

	}

	

	function init() {
		// body...

		container = document.getElementById( 'render' );
		renderer = new THREE.WebGLRenderer({ alpha: true });
		renderer.autoClear = false;//MUst turn it off if you want add multi renders in same buffer
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.setClearColor( 0x000000, 0 ); // the default
		container.appendChild( renderer.domElement );


		window.addEventListener( 'resize', onWindowResize, false );
	}

	function animate() {
		renderLoop = requestAnimationFrame( animate );
		update();
		
	}


	function stop() {
	    if (renderLoop) {
	       cancelAnimationFrame(renderLoop);
	       renderLoop = undefined;
	    }
	    if(renderer){
	    	if(container) container.removeChild(renderer.domElement);
	    	renderer.dispose();
	    	renderer = undefined;
	    }
	    


	    window.removeEventListener( 'resize', onWindowResize, false );
	}


	function update() {
		//root.controls.update();
		//console.log("!");
		//renderer.render( root.scene, root.camera );
		if(cubeView !== undefined && cubeView.enabled){
			cubeView.renderView();
		}
		
		if(outHUD !== undefined && outHUD.enabled){
			outHUD.renderHUD(renderer);
		}
		

	}


	function onWindowResize() {

		if(cubeView !== undefined && cubeView.enabled){
			cubeView.onResize(window.innerWidth,window.innerHeight);
		}

		//Update HUD size here
		if(outHUD !== undefined && outHUD.enabled){
			outHUD.updateHUD( window.innerWidth, window.innerHeight );
		}

	}


	window.onbeforeunload = function() {
  		return "Data will be lost if you leave the page, are you sure?";
	};





</script>

</body>
</html>
